FROM node:22.9.0-alpine AS builder

RUN mkdir /nodejs2024Q3-service

WORKDIR /nodejs2024Q3-service

COPY ./package*.json ./

RUN npm install --omit=dev

COPY . .

RUN npx prisma generate

RUN npm run build

FROM gcr.io/distroless/nodejs

ENV PORT=4000

ENV DATABASE_URL="postgresql://musicLover:libraryRSS@postgres:5432/library?schema=public"

WORKDIR /nodejs2024Q3-service

COPY --from=builder /nodejs2024Q3-service/dist ./dist
COPY --from=builder /nodejs2024Q3-service/prisma ./prisma
COPY --from=builder /nodejs2024Q3-service/node_modules ./node_modules

EXPOSE ${PORT}

CMD ["sh", "-c", "npx prisma migrate deploy && node dist/main"]